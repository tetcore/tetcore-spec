# IFP-104  
## Fee Market & Pricing Models Specification  
**Status:** Draft v1.0  
**Category:** Intelligence Fabric Protocol  

---

# 1. Purpose

This specification defines the deterministic fee computation mechanisms for inference within the Intelligence Fabric Protocol (IFP).

It formalizes:

- Owner-defined pricing
- Operator market pricing
- Hybrid pricing models
- Workload scaling rules
- Deterministic fee constraints

All fee computation must be consensus-deterministic.

---

# 2. Design Principles

Fee computation must be:

- Deterministic
- Integer-based
- Bounded by escrow
- Independent of off-chain time
- Independent of hardware performance

Fees must never exceed:

fee_limit defined in SubmitPrompt.

---

# 3. Fee Variables

Let:

p = input_tokens  
o = output_tokens  
c = compute_units  
E = escrow_amount  
M = model metadata  
mode = pricing_mode  

All variables are unsigned integers.

---

# 4. Owner Pricing Model

---

## 4.1 Definition

Owner pricing is defined in model metadata:

OwnerPricing = {
  base_fee: u128,
  input_token_rate: u128,
  output_token_rate: u128,
  compute_rate: u128
}

---

## 4.2 Fee Formula

F_owner = 
  base_fee
  + (input_token_rate × p)
  + (output_token_rate × o)
  + (compute_rate × c)

All multiplication must use checked arithmetic.

---

## 4.3 Constraints

- F_owner ≤ E
- All rates must be non-negative
- Rates stored on-chain in fixed-point scaled integers

---

# 5. Market Pricing Model

---

## 5.1 Definition

Market pricing allows inference operators to bid execution cost.

Operator submits:

operator_bid: u128

Bid must satisfy:

operator_bid ≤ E

---

## 5.2 Fee Formula

F_market = operator_bid

---

## 5.3 Determinism Constraint

If multiple bids allowed (future extension):

Selection must be deterministic based on:

- Lowest bid
- Tie-break by operator_address lexicographic order

Current version assumes single operator per receipt.

---

# 6. Hybrid Pricing Model

---

## 6.1 Definition

Hybrid pricing combines:

- Owner minimum fee
- Operator competitive bid

---

## 6.2 Formula

Let:

F_min = OwnerPricing formula  
F_bid = operator_bid  

Then:

F_hybrid = max(F_min, F_bid)

---

## 6.3 Escrow Constraint

F_hybrid ≤ E

If F_min > E:

Receipt must fail.

---

# 7. Workload Scaling Rules

---

## 7.1 Token Scaling

Fee components may scale linearly:

Linear scaling:

F ∝ p + o

Nonlinear scaling is not permitted in v1.0.

---

## 7.2 Compute Scaling

Compute_units must be:

- Deterministically reported
- Bounded by governance-defined max

Compute_rate × c must not overflow.

---

## 7.3 Congestion Multiplier (Optional Extension)

Governance MAY define:

congestion_multiplier ∈ u16

Then:

F_scaled = F × congestion_multiplier / SCALE

SCALE must be fixed (e.g., 10000).

Multiplier must be:

- Deterministically derived from block height or usage metrics
- Not derived from wall-clock time

---

# 8. Fee Caps and Escrow Enforcement

Absolute invariant:

F ≤ E

Where:

E = escrow locked in SubmitPrompt

If computed F > E:

Receipt invalid.

---

# 9. Deterministic Rounding Rules

All division must:

- Use integer division
- Round down (floor)
- Use final remainder assignment to last recipient in revenue split

Ensures:

Sum(distributed) = F

---

# 10. Governance-Controlled Parameters

Governance may modify:

- Default base_fee
- Maximum token rates
- Maximum compute_rate
- Congestion multiplier
- Max compute_units allowed

Such changes require runtime upgrade or parameter update transaction.

---

# 11. Fee Market Safety Constraints

Fee system must prevent:

- Negative pricing
- Overflow attacks
- Escrow draining beyond limit
- Zero-cost spam

Minimum base fee may be enforced globally.

---

# 12. Spam Prevention Rule

At minimum:

F ≥ network_minimum_fee

Where:

network_minimum_fee > 0

Defined by governance.

---

# 13. Multi-Operator Future Extension

Future versions may allow:

- Multiple operator bids
- Auction-based selection
- Batch inference routing

Selection rules must remain deterministic.

---

# 14. Economic Invariants

For any inference settlement:

1. F computed deterministically
2. F ≤ escrow
3. Revenue split sum = F
4. Sender refunded (E - F)
5. No token creation or destruction unless explicitly burned

---

# 15. Formal Fee Function

Define:

Fee(mode, p, o, c, bid, metadata, escrow) → F

Where:

if mode == Owner:
  F = F_owner

if mode == Market:
  F = bid

if mode == Hybrid:
  F = max(F_owner, bid)

Constraint:

F ≤ escrow

---

# 16. Security Considerations

Fee market must not:

- Depend on wall-clock time
- Depend on network latency
- Depend on nondeterministic ordering
- Allow dynamic floating-point multipliers

All pricing must be purely state-derived.

---

# 17. Interaction with Revenue Routing

After F determined:

F is passed to:

IFP-105 Revenue Routing Engine

Routing must use deterministic integer arithmetic.

---

# 18. Conclusion

IFP-104 defines:

- Deterministic owner pricing
- Competitive operator pricing
- Hybrid fee logic
- Workload-based scaling
- Strict escrow enforcement

It ensures that inference pricing is:

Predictable  
Bounded  
Deterministic  
Economically programmable  

And compatible with consensus safety.

---

End of IFP-104.