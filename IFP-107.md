# IFP-107  
## Relay Transport Protocol  
**Status:** Draft v1.0  
**Category:** Intelligence Fabric Protocol  

---

# 1. Purpose

This specification defines the off-chain transport layer used for delivering inference payloads between:

- Clients
- Inference Operators
- Optional Relay Nodes

The Relay Transport Protocol (RTP) governs:

- Encrypted prompt delivery
- Output return routing
- Delivery modes
- Metadata handling constraints

This protocol is non-consensus and does NOT affect deterministic state transitions.

---

# 2. Design Principles

Relay transport must:

- Preserve confidentiality
- Preserve integrity
- Avoid plaintext exposure
- Avoid consensus dependency
- Be independent of block execution timing

All transport logic must remain off-chain.

---

# 3. Transport Roles

RTP defines three roles:

1. Client  
2. Relay  
3. Inference Operator  

Relays are optional intermediaries.

---

# 4. Encrypted Prompt Transport

---

## 4.1 Encryption Requirement

Prompt data MUST be encrypted before transmission.

Recommended encryption scheme:

- Ephemeral key exchange (X25519)
- Symmetric encryption (AES-256-GCM or ChaCha20-Poly1305)

Protocol does not mandate specific cipher suite, but encryption is REQUIRED.

---

## 4.2 Encryption Flow (Recommended)

1. Client generates ephemeral keypair
2. Client obtains operator public transport key
3. Shared secret derived via X25519
4. Prompt encrypted with symmetric key
5. Ciphertext transmitted

---

## 4.3 On-Chain Commitment

SubmitPrompt includes:

prompt_commitment = SHA256(prompt || salt)

Encrypted payload MUST correspond to committed data.

---

# 5. Delivery Policies

---

## 5.1 Relay Delivery Mode

relay_mode = 0

Flow:

Client → Relay → Operator  
Operator → Relay → Client

Relays:

- Forward encrypted payload
- Do not decrypt
- Do not modify payload
- May add routing metadata

---

## 5.2 Direct Delivery Mode

relay_mode = 1

Flow:

Client ↔ Operator

Relay layer bypassed.

Protocol-level behavior remains identical.

---

## 5.3 Determinism Constraint

Delivery policy flag affects only:

- Off-chain routing behavior
- Not consensus logic
- Not fee computation
- Not state transitions

---

# 6. Metadata Constraints

---

## 6.1 Allowed Metadata

Transport messages MAY include:

- prompt_tx_hash
- model_id
- version
- max_output_tokens
- delivery timestamp (off-chain only)
- transport session ID

---

## 6.2 Prohibited Metadata

Transport messages MUST NOT:

- Modify prompt content
- Inject unsigned economic data
- Alter committed parameters
- Include on-chain secret keys

---

# 7. Message Structure (Off-Chain)

Recommended RTP message structure:

TransportMessage = {
  protocol_version,
  prompt_tx_hash,
  encrypted_payload,
  encryption_metadata,
  signature
}

Signature optional but recommended for authenticity.

---

# 8. Output Delivery

Operator returns:

encrypted_output

Client verifies:

SHA256(output || salt) == output_commitment

Commitment may be stored locally.

---

# 9. Integrity Verification

Integrity guarantees rely on:

- Cryptographic commitment
- Signature verification
- Escrow enforcement

Relay does NOT guarantee:

- Correct output
- Model correctness
- Operator honesty

These are economically enforced.

---

# 10. Timeout Handling

If operator does not deliver output before deadline_height:

Client may:

- Allow expiry
- Trigger refund via non-receipt
- Submit dispute if applicable

Relay does not intervene in timeout logic.

---

# 11. Relay Node Obligations

Relay nodes MUST:

- Forward ciphertext unmodified
- Not alter headers affecting routing
- Not reorder message contents
- Not retain plaintext

Relay nodes MAY:

- Rate limit
- Apply routing fees (if off-chain agreement)
- Provide QoS guarantees

---

# 12. Privacy Guarantees

Protocol ensures:

- No prompt stored on-chain
- Only commitment hash recorded
- No plaintext in consensus ledger

Transport confidentiality depends on encryption implementation.

---

# 13. DoS Considerations

Relays and operators may implement:

- Rate limiting
- Authentication gating
- Proof-of-payment verification (checking SubmitPrompt existence)

Transport nodes must avoid allowing spam amplification.

---

# 14. Transport Authentication

Optional extension:

Operators may require:

- Signed transport messages
- Pre-authorization tokens
- Receipt pre-validation

Such authentication must not conflict with on-chain verification rules.

---

# 15. Security Assumptions

Security of RTP depends on:

- Encryption strength
- Private key protection
- Proper salt handling
- No plaintext logging

Protocol does not enforce:

- TLS usage
- Specific transport protocol (HTTP, QUIC, libp2p)

Implementation choice is open.

---

# 16. Failure Modes

Relay failure:

Client may retry or switch to direct mode.

Operator failure:

Receipt not submitted → escrow refund.

Transport failure does not affect consensus state.

---

# 17. Interaction with IFP-102 and IFP-103

IFP-102 defines:

- On-chain prompt commitment

IFP-103 defines:

- On-chain receipt settlement

RTP operates strictly between these two phases.

---

# 18. Deterministic Boundary

Critical invariant:

Transport layer must never influence:

- Fee computation
- Escrow locking
- Revenue routing
- State root generation

All consensus logic remains independent.

---

# 19. Future Extensions

Possible extensions include:

- Anonymous routing
- Multi-hop relays
- Encrypted streaming responses
- Payment-channel pre-authorization
- Zero-knowledge output verification

All must preserve consensus isolation.

---

# 20. Conclusion

IFP-107 defines the Relay Transport Protocol as:

- Encrypted
- Off-chain
- Optional relay-mediated
- Commitment-linked
- Consensus-independent

It enables secure inference transport without compromising determinism or privacy.

This completes the transport layer of the Intelligence Fabric Protocol.

---

End of IFP-107.